name: assignment4

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize log.txt
        run: |
          date -Iminutes > log.txt
          echo "Ron Eliav" >> log.txt

      - name: Build images
        id: build_images
        run: |
          set +e
          docker build -t pet-store:latest ./pet_store
          if [ $? -eq 0 ]; then echo "image pet-store successfully built;" >> log.txt; else echo "image pet-store not able to be built;" >> log.txt; exit 1; fi
          docker build -t pet-order:latest ./pet_order
          if [ $? -eq 0 ]; then echo "image pet-order successfully built;" >> log.txt; else echo "image pet-order not able to be built;" >> log.txt; exit 1; fi
          docker save pet-store:latest pet-order:latest -o images.tar

      - name: Upload images + partial log
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            images.tar
            log.txt

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images + log
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load images
        run: |
          docker load -i images.tar

      - name: Start app (containers)
        run: |
          docker compose -f docker-compose.assn4.yml up -d --no-build
          # record container statuses in log
          for c in "pet-store1:pet-store #1" "pet-store2:pet-store #2" "pet-order:pet-order"; do
            name="${c%%:*}"; label="${c##*:}"
            if docker ps --format '{{.Names}}' | grep -q "^${name}$"; then
              echo "Container ${label} up and running;" >> log.txt
            else
              echo "Container ${label} failed to run;" >> log.txt
            fi
          done

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests

      - name: Run pytests
        id: run_tests
        run: |
          set +e
          pytest -v tests/assn4_tests.py | tee assn4_test_results.txt
          code=${PIPESTATUS[0]}
          if [ $code -eq 0 ]; then echo "All pytests succeeded" >> log.txt; else echo "pytests failed" >> log.txt; fi
          exit $code

      - name: Upload pytest results + log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            assn4_test_results.txt
            log.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.assn4.yml down -v || true

  query:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images + log
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load images
        run: |
          docker load -i images.tar

      - name: Start app (containers)
        run: |
          docker compose -f docker-compose.assn4.yml up -d --no-build

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run query job
        run: |
          python query_runner.py

      - name: Upload response.txt (and final log)
        uses: actions/upload-artifact@v4
        with:
          name: query-artifacts
          path: |
            response.txt
            log.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.assn4.yml down -v || true
