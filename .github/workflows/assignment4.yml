name: assignment4

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize log.txt
        run: |
          date -Iminutes > log.txt
          echo "Ron Eliav" >> log.txt

      - name: Build images (Line 3 in ONE line; terminate on failure)
        run: |
          set +e

          logline=""

          docker build -t pet-store:latest ./pet_store
          if [ $? -eq 0 ]; then
            logline="${logline}image pet-store successfully built; "
          else
            logline="${logline}image pet-store not able to be built; "
            echo "${logline}" >> log.txt
            exit 1
          fi

          docker build -t pet-order:latest ./pet_order
          if [ $? -eq 0 ]; then
            logline="${logline}image pet-order successfully built; "
          else
            logline="${logline}image pet-order not able to be built; "
            echo "${logline}" >> log.txt
            exit 1
          fi

          # Write Line 3 (single line)
          echo "${logline}" >> log.txt

          # Pack images for next jobs
          docker save pet-store:latest pet-order:latest -o images.tar

      - name: Upload images
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: images.tar

      - name: Upload partial log (job1)
        uses: actions/upload-artifact@v4
        with:
          name: job1-log
          path: log.txt


  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Download partial log (job1)
        uses: actions/download-artifact@v4
        with:
          name: job1-log


      - name: Load images
        run: |
          docker load -i images.tar

      - name: Start app (containers)
        run: |
          docker compose -f docker-compose.yml up -d --no-build

      - name: Record container statuses (Line 4 in ONE line)
        run: |
          logline=""
          for c in "pet-store1:pet-store #1" "pet-store2:pet-store #2" "pet-order:pet-order"; do
            name="${c%%:*}"; label="${c##*:}"
            if docker ps --format '{{.Names}}' | grep -q "^${name}$"; then
              logline="${logline}Container ${label} up and running; "
            else
              logline="${logline}Container ${label} failed to run; "
            fi
          done
          echo "${logline}" >> log.txt

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests

      - name: Run pytests
        id: run_tests
        run: |
          set +e
          pytest -v tests/assn4_tests.py | tee assn4_test_results.txt
          code=${PIPESTATUS[0]}
          if [ $code -eq 0 ]; then
            echo "All pytests succeeded;" >> log.txt
          else
            echo "pytests failed;" >> log.txt
          fi
          exit $code


      - name: Upload pytest results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: assn4_test_results.txt

      - name: Upload final log.txt after test (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log.txt
          path: log.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v || true

  query:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download images + log
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load images
        run: |
          docker load -i images.tar

      - name: Start app (containers)
        run: |
          docker compose -f docker-compose.yml up -d --no-build

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run query job
        run: |
          python query_runner.py

      - name: Upload response.txt (and final log)
        uses: actions/upload-artifact@v4
        with:
          name: query-artifacts
          path: |
            response.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v || true
